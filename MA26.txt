<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPS MarketAnalyzer Pro v11.3 (Visual Update)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Math.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>

    <style>
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Estilo para filas clickables */
        .cursor-pointer:hover { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen font-sans flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-chart-simple text-blue-400 text-xl"></i>
                <h1 class="text-xl font-bold tracking-wide">MPS Market<span class="text-blue-400">Analyzer</span> Pro</h1>
            </div>
            <div class="text-xs text-gray-400 hidden sm:block">v11.3 (Visual Update)</div>
        </div>
    </nav>

    <!-- Layout -->
    <div class="container mx-auto p-4 lg:p-6 flex flex-col lg:flex-row gap-6 flex-grow">
        
        <!-- Sidebar -->
        <aside class="w-full lg:w-1/4 space-y-6 flex-shrink-0">
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200 sticky top-24">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-700">
                    <i class="fa-solid fa-sliders text-blue-500"></i> Parámetros
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticker (Yahoo)</label>
                        <div class="relative">
                            <input type="text" id="tickerInput" value="SPY" 
                                class="w-full p-2 pl-9 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase font-mono text-sm"
                                placeholder="Ej: SPY">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400 text-xs"></i>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">Prueba: ^STOXX50E, BTC-USD, AAPL</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Inicio</label>
                            <input type="date" id="startDate" value="2000-01-01" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Fin</label>
                            <input type="date" id="endDate" value="2025-11-20" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <button onclick="runAnalysis()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex justify-center items-center gap-2">
                        <i class="fa-solid fa-bolt"></i> Ejecutar Análisis
                    </button>
                </div>
                <div id="statusBox" class="mt-4 hidden p-3 bg-blue-50 border border-blue-100 rounded-lg flex items-start gap-2">
                    <i class="fa-solid fa-circle-info text-blue-500 mt-1 text-xs"></i>
                    <p id="statusText" class="text-xs text-blue-800 leading-tight">Esperando...</p>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="w-full lg:w-3/4 flex flex-col min-h-[500px]">
            <div id="loader" class="hidden flex-grow flex flex-col justify-center items-center bg-white/50 rounded-xl backdrop-blur-sm z-10 absolute inset-0 lg:relative">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-500 font-medium animate-pulse">Procesando datos...</p>
            </div>

            <div id="resultsArea" class="hidden space-y-4">
                <!-- Tabs -->
                <div class="flex overflow-x-auto border-b border-gray-200 bg-white rounded-t-xl px-2 scrollbar-hide">
                    <button onclick="switchTab('general')" id="tab-general" class="tab-btn active px-6 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>General
                    </button>
                    <button onclick="switchTab('drawdown')" id="tab-drawdown" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-arrow-trend-down mr-2"></i>Drawdowns
                    </button>
                    <button onclick="switchTab('rolling')" id="tab-rolling" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-chart-line mr-2"></i>Rolling
                    </button>
                    <button onclick="switchTab('seasonality')" id="tab-seasonality" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-calendar-days mr-2"></i>Estacionalidad
                    </button>
                    <button onclick="switchTab('vix')" id="tab-vix" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-radiation mr-2"></i>VIX
                    </button>
                    <button onclick="switchTab('oil')" id="tab-oil" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-oil-well mr-2"></i>Petróleo
                    </button>
                    <button onclick="switchTab('correlation')" id="tab-correlation" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-link mr-2"></i>Correlaciones
                    </button>
                    <button onclick="switchTab('help')" id="tab-help" class="tab-btn px-6 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent hover:text-gray-700 focus:outline-none transition-colors hover:bg-gray-50 whitespace-nowrap">
                        <i class="fa-solid fa-circle-question mr-2"></i>Ayuda
                    </button>
                </div>

                <!-- TAB 1: General Analysis + Best Days -->
                <div id="content-general" class="tab-content active space-y-6">
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-2 border-b pb-2 border-gray-100">
                            <h3 class="text-gray-800 font-bold border-l-4 border-purple-500 pl-3">Precio, Medias Móviles (MA50/MA200) & RSI</h3>
                        </div>
                        <div id="technicalChart" class="w-full h-[600px]"></div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-teal-500 pl-3">Resumen de Métricas Principales</h3>
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="min-w-full text-sm text-left text-gray-600"><tbody id="metricsTableBody" class="divide-y divide-gray-100"></tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-gray-800 font-bold mb-2 border-l-4 border-blue-500 pl-3">Serie de Retornos y Bandas Sigma (±1, ±2, ±3)</h3>
                        <div id="returnsChart" class="w-full h-[400px]"></div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-red-600 pl-3">Eventos Extremos (Cisnes Negros: > ±3 Sigma)</h3>
                        <div class="overflow-x-auto custom-scrollbar max-h-[300px]">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-red-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3">Fecha</th>
                                        <th class="px-4 py-3 text-right">Rentabilidad</th>
                                        <th class="px-4 py-3 text-right">Desviación (Sigmas)</th>
                                    </tr>
                                </thead>
                                <tbody id="sigmaEventsTableBody" class="divide-y divide-gray-100">
                                    <!-- JS filled -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Distribución de Rentabilidades Diarias</h3><div id="returnsHistogram" class="w-full h-[400px]"></div></div>
                    
                    <div class="border-t-4 border-gray-300 pt-6 mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-gem text-purple-600"></i> Análisis de Impacto: Mejores Días</h2>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
                            <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-purple-500 pl-3">Patrimonio Final: Siempre invertido vs Saltando los mejores días</h3>
                            <div id="bestDaysBarChart" class="w-full h-[400px]"></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-blue-500 pl-3">Top 10 Mejores Días</h3>
                                <div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-blue-50"><tr><th class="px-4 py-2">#</th><th class="px-4 py-2">Fecha</th><th class="px-4 py-2 text-right">Retorno</th></tr></thead><tbody id="top10TableBody" class="divide-y divide-gray-100"></tbody></table></div>
                            </div>
                            <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-gray-800 font-bold mb-2 border-l-4 border-red-500 pl-3">¿Cuándo ocurrieron los mejores días?</h3>
                                <div id="bestDaysLocationChart" class="w-full h-[400px]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB 2: Drawdown + Dip + Duration -->
                <div id="content-drawdown" class="tab-content space-y-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-red-500 pl-3">Curva de Drawdown Submarina</h3><div id="drawdownChart" class="w-full h-[400px]"></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-orange-500 pl-3">Top 10 Peores Episodios</h3><div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-red-50"><tr><th class="px-4 py-3 rounded-tl-lg">#</th><th class="px-4 py-3">Caída (DD)</th><th class="px-4 py-3">Inicio (Pico)</th><th class="px-4 py-3">Fondo (Trough)</th><th class="px-4 py-3">Recuperación</th><th class="px-4 py-3">Duración</th><th class="px-4 py-3 rounded-tr-lg">Días bajo agua</th></tr></thead><tbody id="drawdownTableBody" class="divide-y divide-gray-100"></tbody></table></div></div>
                    
                    <div class="border-t-4 border-gray-300 pt-6 mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-money-bill-trend-up text-green-600"></i> Estrategia: Buy the Dip</h2>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4"><h3 class="text-gray-800 font-bold border-l-4 border-green-500 pl-3">Rentabilidad tras Caídas</h3><select id="dipThresholdSelect" onchange="updateDipWidgets()" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2"><option value="5%">Caída > 5%</option><option value="10%">Caída > 10%</option><option value="20%">Caída > 20%</option></select></div>
                            <div class="overflow-x-auto custom-scrollbar mb-6"><table class="min-w-full text-sm border border-gray-200 rounded-lg"><thead class="text-xs bg-green-50"><tr><th class="px-4 py-3">Horizonte</th><th class="px-4 py-3 text-right">Rent. Media</th><th class="px-4 py-3 text-right">Rent. Mediana</th><th class="px-4 py-3 text-right text-green-600">Máxima</th><th class="px-4 py-3 text-right text-red-500">Mínima</th><th class="px-4 py-3 text-right">Win Rate</th><th class="px-4 py-3 text-right">Eventos</th></tr></thead><tbody id="dipStatsTableBody" class="divide-y divide-gray-100"></tbody></table></div>
                            
                            <div class="mt-8 mb-6 border-t border-gray-100 pt-6">
                                <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-purple-600 pl-3">Análisis de Duración y Recuperación</h3>
                                <div class="overflow-x-auto custom-scrollbar border border-gray-200 rounded-lg">
                                    <table class="min-w-full text-sm text-left text-gray-600">
                                        <thead class="text-xs text-gray-700 uppercase bg-purple-50">
                                            <tr><th class="px-4 py-3">Umbral Caída</th><th class="px-4 py-3 text-center">Eventos</th><th class="px-4 py-3 text-right">Días al Mínimo (Prom)</th><th class="px-4 py-3 text-right">% Ya en Mínimo (en día prom)</th><th class="px-4 py-3 text-right">Días Underwater (Prom)</th><th class="px-4 py-3 text-right">% Ya Recuperado (en día prom)</th><th class="px-4 py-3 text-right">Tasa Recup.</th></tr>
                                        </thead>
                                        <tbody id="ddDurationTableBody" class="divide-y divide-gray-100 bg-white"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="border border-gray-100 rounded-xl p-2"><div id="dipFanChart" class="w-full h-[350px]"></div></div><div class="border border-gray-100 rounded-xl p-2"><div id="dipBarChart" class="w-full h-[350px]"></div></div></div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="border border-gray-100 rounded-xl p-2"><div id="dipHistChart" class="w-full h-[350px]"></div></div><div class="border border-gray-100 rounded-xl p-2"><div id="dipScatterChart" class="w-full h-[350px]"></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- TAB 3: Rolling + ATH -->
                <div id="content-rolling" class="tab-content space-y-6">
                    <div class="bg-white p-5 rounded-b-xl rounded-tr-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-blue-500 pl-3">Estadísticas Resumen</h3><div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-3">Horizonte</th><th class="px-4 py-3 text-right">Media Total</th><th class="px-4 py-3 text-right text-blue-600">Media Anualiz.</th><th class="px-4 py-3 text-right text-red-500">Min (Tot)</th><th class="px-4 py-3 text-right text-green-600">Max (Tot)</th></tr></thead><tbody id="statsTableBody" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div class="grid grid-cols-1 gap-6"><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><div id="barChart" class="w-full h-[350px]"></div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><div id="lineChart" class="w-full h-[400px]"></div></div></div>
                    <div class="border-t-4 border-gray-300 pt-6 mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i class="fa-solid fa-trophy text-yellow-500"></i> Análisis de Máximos Históricos (ATH)</h2>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6"><div class="flex justify-between items-center mb-2 border-b pb-2 border-gray-100"><h3 class="text-gray-800 font-bold border-l-4 border-yellow-500 pl-3">Evolución y Nuevos Máximos</h3><span class="text-xs text-gray-500 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> Nuevo Máximo</span></div><div id="athPriceChart" class="w-full h-[400px]"></div></div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4"><h3 class="text-gray-800 font-bold border-l-4 border-blue-600 pl-3">Comparativa ATH vs Aleatorio</h3><select id="athHorizonSelect" onchange="updateATHWidgets()" class="bg-gray-50 border border-gray-300 text-sm rounded-lg p-2"><option value="1M">1 Mes</option><option value="3M">3 Meses</option><option value="6M">6 Meses</option><option value="12M">12 Meses</option><option value="24M">24 Meses</option></select></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 overflow-x-auto"><table class="min-w-full text-sm border border-gray-200 rounded-lg"><tbody id="athStatsTableBody" class="divide-y divide-gray-100"></tbody></table><div id="ttestResult" class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-600 font-mono"></div></div><div class="lg:col-span-2"><div id="athHistogram" class="w-full h-[300px]"></div></div></div></div>
                    </div>
                </div>

                <!-- TAB 4: Seasonality -->
                <div id="content-seasonality" class="tab-content space-y-6">
                    <!-- Annual Distribution -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Distribución de Rentabilidades Anuales (Cronológico)</h3><div id="annualDistChart" class="w-full h-[500px]"></div></div>

                    <!-- NEW Annual Histogram with Years -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Distribución de Rentabilidades Anuales (Histograma de Años)</h3>
                        <p class="text-sm text-gray-500 mb-4">Años agrupados por intervalo de rentabilidad. El año actual se destaca en rojo.</p>
                        <div id="annualDistHistChart" class="w-full h-[500px]"></div>
                    </div>
                    
                    <!-- YoY Comparativo -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mt-6">
                        <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-pink-600 pl-3">Comparativa Estacional (Año vs Años Anteriores)</h3>
                        <p class="text-sm text-gray-500 mb-2">Evolución acumulada YTD (Year to Date). La línea roja es el año actual. Las grises son años pasados.</p>
                        <div id="seasonalityYoYChart" class="w-full h-[600px]"></div>
                    </div>

                    <!-- Ranking y Proyección -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-gray-800 font-bold mb-4 border-l-4 border-green-600 pl-3">Ranking de Rentabilidad y Proyección Fin de Año</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 overflow-x-auto custom-scrollbar">
                                <table class="min-w-full text-sm text-left text-gray-600">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Año</th><th class="px-4 py-3 text-right">Cierre YTD (Corte)</th><th class="px-4 py-3 text-right">Resto del Año</th><th class="px-4 py-3 text-right">Total Año</th></tr></thead>
                                    <tbody id="rankingYoYTableBody" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                            <div class="lg:col-span-1 bg-blue-50 p-5 rounded-xl border border-blue-100">
                                <h4 class="font-bold text-blue-800 mb-3 uppercase text-xs tracking-wide">Proyección Estadística (Mediana)</h4>
                                <div id="projectionStatsBox" class="space-y-3 text-sm text-gray-700"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Estacionalidad Semanal (Semana Actual en Negro)</h3><div id="weeklyChart" class="w-full h-[350px]"></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Estacionalidad Mensual</h3><div id="monthlyChart" class="w-full h-[350px]"></div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-2 border-l-4 border-indigo-500 pl-3">Estacionalidad Trimestral</h3><div id="quarterlyChart" class="w-full h-[350px]"></div></div></div>
                    <div class="border-t-4 border-gray-300 pt-6 mt-8">
                         <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><i class="fa-regular fa-calendar-check text-green-500"></i> Rentabilidad por Intervalos (1 Año Móvil)</h2>
                         <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-green-500 pl-3">Detalle por Periodos (252 días)</h3><div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-green-50"><tr><th class="px-4 py-3 rounded-tl-lg">Periodo</th><th class="px-4 py-3 text-right">Rentabilidad</th><th class="px-4 py-3 text-right rounded-tr-lg">Volatilidad (Std Dev)</th></tr></thead><tbody id="annualTableBody" class="divide-y divide-gray-100 font-mono"></tbody></table></div></div>
                    </div>
                </div>

                <!-- TAB: ANÁLISIS VIX -->
                <div id="content-vix" class="tab-content space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-purple-600 pl-3">Evolución del Índice del Miedo (^VIX)</h3><div id="vixPriceChart" class="w-full h-[400px]"></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-gray-800 font-bold border-l-4 border-purple-600 pl-3">Retornos tras eventos de Pánico</h3>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-bold text-gray-600">Umbral VIX > </label>
                                <select id="vixThresholdSelect" onchange="updateVixWidgets()" class="bg-purple-50 border border-purple-300 text-sm rounded-lg p-2 font-bold text-purple-700 focus:ring-2 focus:ring-purple-500">
                                    <option value="15">15</option>
                                    <option value="20" selected>20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                    <option value="40">40</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Horizonte</th><th class="px-4 py-3 text-center">Eventos</th><th class="px-4 py-3 text-right">Rent. Media</th><th class="px-4 py-3 text-right">Rent. Mediana</th><th class="px-4 py-3 text-right text-red-500">Min</th><th class="px-4 py-3 text-right text-green-600">Max</th><th class="px-4 py-3 text-right">Eventos Positivos</th><th class="px-4 py-3 text-right font-bold">Ratio Positivos</th></tr></thead><tbody id="vixStatsTableBody" class="divide-y divide-gray-100"></tbody></table></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-purple-600 pl-3">Rentabilidad Media (con rango Min/Max)</h3><div id="vixBarChart" class="w-full h-[400px]"></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-purple-600 pl-3">Distribución Rentabilidades (12 Meses)</h3><div id="vixHistogram" class="w-full h-[400px]"></div></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-blue-600 pl-3">Correlación: Valor VIX vs Rentabilidad Futura 12M</h3><div id="vixScatterChart" class="w-full h-[500px]"></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-red-600 pl-3">Top 10 Picos Históricos del VIX y Retornos Posteriores</h3><div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-red-50"><tr><th class="px-4 py-3">Fecha</th><th class="px-4 py-3 text-right font-bold text-red-600">VIX Pico</th><th class="px-4 py-3 text-right">1 Año (252d)</th><th class="px-4 py-3 text-right">3 Años (756d)</th><th class="px-4 py-3 text-right">5 Años (1260d)</th></tr></thead><tbody id="vixPeaksTableBody" class="divide-y divide-gray-100"></tbody></table></div></div>
                </div>

                <!-- TAB: IMPACTO PETRÓLEO -->
                <div id="content-oil" class="tab-content space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-black pl-3">Evolución del Precio del Petróleo (CL=F)</h3><p class="text-sm text-gray-500 mb-4">Línea roja indica el umbral de 100 USD.</p><div id="oilPriceChart" class="w-full h-[400px]"></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-black pl-3">Resumen del Estudio: Retornos tras superar 100 USD</h3><div class="overflow-x-auto custom-scrollbar"><table class="min-w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Horizonte</th><th class="px-4 py-3 text-center">Eventos</th><th class="px-4 py-3 text-right">Rent. Media</th><th class="px-4 py-3 text-right">Rent. Mediana</th><th class="px-4 py-3 text-right text-red-500">Min</th><th class="px-4 py-3 text-right text-green-600">Max</th><th class="px-4 py-3 text-right">Eventos Positivos</th><th class="px-4 py-3 text-right font-bold">Ratio Positivos</th></tr></thead><tbody id="oilStatsTableBody" class="divide-y divide-gray-100"></tbody></table></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-black pl-3">Rentabilidad Media (con rango Min/Max)</h3><div id="oilBarChart" class="w-full h-[400px]"></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-black pl-3">Histograma Rentabilidad (6 Meses)</h3><div id="oilHistogram" class="w-full h-[400px]"></div></div></div>
                </div>

                <!-- TAB: CORRELACIONES -->
                <div id="content-correlation" class="tab-content space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-gray-700 pl-3">Configuración de Correlaciones</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><div class="md:col-span-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Activos (separados por coma)</label><input type="text" id="corrTickersInput" value="SPY, QQQ, GLD, TLT, CL=F, ^VIX" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 uppercase font-mono text-sm" placeholder="Ej: SPY, GLD, BTC-USD"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Frecuencia</label><select id="corrFrequency" class="w-full p-2 border border-gray-300 rounded-lg text-sm"><option value="M" selected>Mensual</option><option value="6M">Semestral</option><option value="A">Anual</option><option value="D">Diaria (Ruidosa)</option></select></div></div><button onclick="runCorrelationAnalysis()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-md text-sm"><i class="fa-solid fa-calculator mr-2"></i> Calcular Matriz y Rolling</button></div>
                    <div id="corrResults" class="hidden space-y-6">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-blue-600 pl-3">Matriz de Correlaciones</h3><div id="corrMatrixChart" class="w-full h-[600px]"></div></div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-gray-800 font-bold mb-4 border-l-4 border-indigo-600 pl-3">Rolling Correlation (Dinámica)</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-gray-50 p-4 rounded-lg"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Activo A</label><select id="rollAssetA" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"></select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Activo B</label><select id="rollAssetB" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white"></select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ventana (Periodos)</label><input type="number" id="rollWindow" value="12" min="2" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></div><div class="md:col-span-3"><button onclick="updateRollingChart()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-xs">Actualizar Gráfico Rolling</button></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><div id="rollingCorrChart" class="w-full h-[400px]"></div></div><div class="lg:col-span-1"><div id="rollingHistChart" class="w-full h-[400px]"></div></div></div></div>
                    </div>
                </div>

                <!-- TAB: HELP & TICKERS -->
                <div id="content-help" class="tab-content space-y-6">
                    <!-- Manual -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-book text-blue-500"></i> Funcionamiento del Programa</h2>
                        <div class="space-y-3 text-sm text-gray-600 leading-relaxed">
                            <p><strong class="text-gray-900">¿Qué hace esta app?</strong> Herramienta de análisis financiero 100% del lado del cliente.</p>
                        </div>
                    </div>

                    <!-- Diccionario de Tickers -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass-dollar text-green-600"></i> Diccionario de Tickers Comunes</h2>
                        <p class="text-sm text-gray-500 mb-4">Busca activos comunes para obtener su código (Ticker) de Yahoo Finance.</p>
                        
                        <div class="relative mb-4">
                            <input type="text" id="tickerSearch" onkeyup="filterTickers()" 
                                class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm"
                                placeholder="Buscar por nombre o símbolo (ej: Inditex, Oro, S&P 500)...">
                            <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-400"></i>
                        </div>

                        <div class="overflow-y-auto max-h-[500px] custom-scrollbar border rounded-lg">
                            <table class="min-w-full text-sm text-left text-gray-600">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                    <tr><th class="px-4 py-3">Símbolo</th><th class="px-4 py-3">Nombre / Descripción</th><th class="px-4 py-3">Tipo</th></tr>
                                </thead>
                                <tbody id="tickerTableBody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const horizonsRolling = { '3 meses': 63, '12 meses': 252, '5 años': 1260, '10 años': 2520, '15 años': 3780 };
        const seriesHorizons = { '1 Año': 252, '5 Años': 5 * 252, '15 Años': 15 * 252 };
        let currentData = [];
        let globalATHResults = null; 
        let globalDipResults = null;
        let globalCorrData = null;
        let globalVixData = null; // Store VIX data globally
        let globalOilData = null;

        // --- Ticker Dictionary Data ---
        const commonTickers = [
            {s:'^GSPC', n:'S&P 500 (Indice EEUU)', t:'Índice'},
            {s:'^NDX', n:'Nasdaq 100 (Tecnología EEUU)', t:'Índice'},
            {s:'^DJI', n:'Dow Jones Industrial Average', t:'Índice'},
            {s:'^STOXX50E', n:'Euro Stoxx 50 (Europa)', t:'Índice'},
            {s:'^IBEX', n:'IBEX 35 (España)', t:'Índice'},
            {s:'^DAX', n:'DAX 40 (Alemania)', t:'Índice'},
            {s:'^N225', n:'Nikkei 225 (Japón)', t:'Índice'},
            {s:'SPY', n:'SPDR S&P 500 ETF Trust', t:'ETF'},
            {s:'QQQ', n:'Invesco QQQ Trust (Nasdaq)', t:'ETF'},
            {s:'IWM', n:'iShares Russell 2000 (Small Caps)', t:'ETF'},
            {s:'EEM', n:'iShares MSCI Emerging Markets', t:'ETF'},
            {s:'TLT', n:'iShares 20+ Year Treasury Bond (Bonos)', t:'ETF'},
            {s:'GLD', n:'SPDR Gold Shares (Oro físico)', t:'ETF'},
            {s:'SLV', n:'iShares Silver Trust (Plata)', t:'ETF'},
            {s:'AAPL', n:'Apple Inc.', t:'Acción'},
            {s:'MSFT', n:'Microsoft Corporation', t:'Acción'},
            {s:'NVDA', n:'NVIDIA Corporation', t:'Acción'},
            {s:'AMZN', n:'Amazon.com', t:'Acción'},
            {s:'GOOGL', n:'Alphabet Inc. (Google)', t:'Acción'},
            {s:'TSLA', n:'Tesla, Inc.', t:'Acción'},
            {s:'META', n:'Meta Platforms (Facebook)', t:'Acción'},
            {s:'BRK-B', n:'Berkshire Hathaway Inc.', t:'Acción'},
            {s:'ITX.MC', n:'Inditex (España)', t:'Acción'},
            {s:'SAN.MC', n:'Banco Santander (España)', t:'Acción'},
            {s:'BBVA.MC', n:'BBVA (España)', t:'Acción'},
            {s:'TEF.MC', n:'Telefónica (España)', t:'Acción'},
            {s:'CL=F', n:'Petróleo Crudo (Futuros)', t:'Commodity'},
            {s:'GC=F', n:'Oro (Futuros)', t:'Commodity'},
            {s:'SI=F', n:'Plata (Futuros)', t:'Commodity'},
            {s:'NG=F', n:'Gas Natural (Futuros)', t:'Commodity'},
            {s:'HG=F', n:'Cobre (Futuros)', t:'Commodity'},
            {s:'BTC-USD', n:'Bitcoin USD', t:'Cripto'},
            {s:'ETH-USD', n:'Ethereum USD', t:'Cripto'},
            {s:'SOL-USD', n:'Solana USD', t:'Cripto'},
            {s:'EURUSD=X', n:'Euro / Dólar', t:'Divisa'},
            {s:'^VIX', n:'VIX (Índice de Volatilidad)', t:'Índice'},
            {s:'TTF=F', n:'Gas Natural Dutch TTF (Europa)', t:'Commodity'}
        ];

        function renderTickerDictionary() {
            const tbody = document.getElementById('tickerTableBody');
            tbody.innerHTML = commonTickers.map(item => `
                <tr class="border-b hover:bg-blue-50 cursor-pointer transition-colors" onclick="selectTicker('${item.s}')">
                    <td class="px-4 py-3 font-mono font-bold text-blue-600">${item.s}</td>
                    <td class="px-4 py-3 text-gray-800">${item.n}</td>
                    <td class="px-4 py-3 text-xs uppercase tracking-wide text-gray-500">${item.t}</td>
                </tr>
            `).join('');
        }

        function filterTickers() {
            const input = document.getElementById('tickerSearch');
            const filter = input.value.toUpperCase();
            const tbody = document.getElementById('tickerTableBody');
            const tr = tbody.getElementsByTagName('tr');
            for (let i = 0; i < tr.length; i++) {
                const tdSym = tr[i].getElementsByTagName("td")[0];
                const tdName = tr[i].getElementsByTagName("td")[1];
                if (tdSym || tdName) {
                    const txtSym = tdSym.textContent || tdSym.innerText;
                    const txtName = tdName.textContent || tdName.innerText;
                    if (txtSym.toUpperCase().indexOf(filter) > -1 || txtName.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }       
            }
        }

        function selectTicker(ticker) {
            document.getElementById('tickerInput').value = ticker;
            switchTab('general'); // Go back to main tab
            alert(`Ticker ${ticker} seleccionado. ¡Pulsa "Ejecutar Análisis"!`);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
            activeBtn.classList.remove('text-gray-500', 'border-transparent');

            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.add('active');
            
            window.dispatchEvent(new Event('resize'));
        }

        function updateATHWidgets() {
            const horizon = document.getElementById('athHorizonSelect').value;
            if(globalATHResults && globalATHResults[horizon]) renderATHWidgets(globalATHResults[horizon]);
        }

        function updateDipWidgets() {
            const threshold = document.getElementById('dipThresholdSelect').value;
            if(globalDipResults) {
                const filtered = globalDipResults.filter(r => r.Umbral === threshold);
                if(filtered.length > 0) renderDipAnalysisCharts(filtered, globalDipResults.rawEvents[threshold], threshold);
            }
        }

        function updateVixWidgets() {
            if(!currentData || !globalVixData) return;
            const threshold = parseFloat(document.getElementById('vixThresholdSelect').value);
            const vixAnalysisData = calculateVixAnalysis(currentData, globalVixData, threshold);
            renderVixAnalysis(vixAnalysisData, globalVixData, threshold);
        }

        async function runAnalysis() {
            const ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!ticker) return alert("Por favor ingresa un ticker.");

            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('statusBox').classList.remove('hidden');
            updateStatus(`Conectando a Yahoo Finance para ${ticker}...`);

            try {
                // Fetch main Ticker, Oil (CL=F), and VIX (^VIX)
                const [rawData, oilData, vixData] = await Promise.all([
                    fetchYahooData(ticker, startDate, endDate),
                    fetchYahooData('CL=F', startDate, endDate).catch(e => { console.warn("No se pudo bajar Oil", e); return []; }),
                    fetchYahooData('^VIX', startDate, endDate).catch(e => { console.warn("No se pudo bajar VIX", e); return []; })
                ]);

                currentData = rawData;
                globalVixData = vixData; // Store globally
                globalOilData = oilData;

                updateStatus(`Calculando indicadores para ${rawData.length} registros...`);

                const stats = calculateRollingStats(rawData);
                const timeSeries = calculateTimeSeries(rawData);
                const ddData = calculateDrawdownData(rawData);
                const episodes = calculateEpisodes(rawData, ddData.cumulativeMax);
                const yearlyStats = calculateYearlyStats(rawData);
                const techData = calculateTechnicalIndicators(rawData);
                const seasonData = calculateSeasonality(rawData);
                const annualDist = calculateAnnualDistribution(rawData);
                const athData = calculateATHAnalysis(rawData);
                const generalData = calculateGeneralMetrics(rawData); 
                const dipData = calculateDipAnalysis(rawData, ddData.drawdowns);
                const bestDaysData = calculateBestDaysAnalysis(rawData);
                const oilAnalysisData = calculateOilAnalysis(rawData, oilData);
                
                // VIX Initial Calculation (default 20)
                const vixThreshold = parseFloat(document.getElementById('vixThresholdSelect').value);
                const vixAnalysisData = calculateVixAnalysis(rawData, vixData, vixThreshold);
                
                const ddDurationData = calculateDrawdownDurations(rawData, ddData.cumulativeMax);
                const yoyAnalysisData = calculateYoYAnalysis(rawData);

                globalATHResults = athData.results;
                globalDipResults = dipData;

                renderTable(stats);
                renderBarChart(stats);
                renderLineChart(timeSeries);
                renderDrawdownChart(rawData, ddData, ticker);
                renderDrawdownTable(episodes);
                renderYearlyTable(yearlyStats);
                renderTechnicalChart(rawData, techData, ticker);
                renderGeneralMetrics(generalData, ticker); 
                renderSeasonalityCharts(seasonData, ticker);
                renderAnnualDistributionChart(annualDist, ticker);
                renderAnnualHistWithYears(annualDist); // NEW REPLACEMENT
                renderATHPriceChart(rawData, athData.recordIndices, ticker);
                updateATHWidgets();
                updateDipWidgets();
                renderBestDaysCharts(bestDaysData, ticker);
                renderOilAnalysis(oilAnalysisData, oilData);
                renderVixAnalysis(vixAnalysisData, vixData, vixThreshold);
                renderDrawdownDurationTable(ddDurationData);
                renderSeasonalityYoY(yoyAnalysisData, ticker);
                
                // Render New Sigma Table
                renderSigmaEvents(generalData);

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('resultsArea').classList.remove('hidden');
                updateStatus("Análisis completado.");
                setTimeout(() => window.dispatchEvent(new Event('resize')), 100);

            } catch (error) {
                console.error(error);
                document.getElementById('loader').classList.add('hidden');
                updateStatus("Error: " + error.message);
                alert(`Error: ${error.message}`);
            }
        }

        function updateStatus(msg) { document.getElementById('statusText').innerText = msg; }

        async function fetchYahooData(ticker, startStr, endStr) {
            const period1 = Math.floor(new Date(startStr).getTime() / 1000);
            const period2 = Math.floor(new Date(endStr).getTime() / 1000);
            const corsProxy = "https://corsproxy.io/?"; 
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?period1=${period1}&period2=${period2}&interval=1d&events=history`;
            const response = await fetch(corsProxy + encodeURIComponent(yahooUrl));
            if (!response.ok) throw new Error(`Error API Yahoo para ${ticker}`);
            const json = await response.json();
            const result = json.chart.result?.[0];
            if (!result) throw new Error(`Sin datos para ${ticker}`);
            const timestamps = result.timestamp || [];
            const quotes = result.indicators.quote[0];
            const adjClose = result.indicators.adjclose?.[0]?.adjclose || quotes.close;
            const data = [];
            for (let i = 0; i < timestamps.length; i++) {
                if (timestamps[i] && adjClose[i] != null) {
                    data.push({ date: new Date(timestamps[i] * 1000), price: adjClose[i] });
                }
            }
            return data;
        }

        // --- HELPER: REGRESSION (Calcula pendiente, intercepto y R2) ---
        function calculateRegressionStats(x, y) {
            const n = x.length;
            if (n < 2) return { slope: 0, intercept: 0, r2: 0 };
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumYY = y.reduce((sum, yi) => sum + yi * yi, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // R2 Calculation
            const ssTot = sumYY - (sumY * sumY) / n;
            const ssRes = y.reduce((acc, yi, i) => acc + Math.pow(yi - (slope * x[i] + intercept), 2), 0);
            const r2 = 1 - (ssRes / ssTot);

            return { slope, intercept, r2 };
        }

        // --- HELPER: NORMAL DISTRIBUTION CURVE (Para Histogramas) ---
        function getNormalDensity(xValues, mean, stdDev) {
            return xValues.map(x => {
                return (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
            });
        }
        
        function calculateDrawdownDurations(data, cumMax) {
            const thresholds = { '5%': -0.05, '10%': -0.10, '20%': -0.20 };
            const durationResults = [];
            const drawdowns = [];
            for(let i=0; i<data.length; i++) { drawdowns.push(data[i].price / cumMax[i] - 1); }
            for (const [threshLabel, threshVal] of Object.entries(thresholds)) {
                const daysToBottom = [];
                const daysUnderwater = [];
                const rawIndices = [];
                for(let i=0; i<drawdowns.length; i++) { if(drawdowns[i] <= threshVal) rawIndices.push(i); }
                const eventStartIndices = []; 
                if(rawIndices.length > 0) {
                    eventStartIndices.push(rawIndices[0]);
                    for(let k=1; k<rawIndices.length; k++) { if(rawIndices[k] - rawIndices[k-1] > 1) { eventStartIndices.push(rawIndices[k]); } }
                }
                for (const eventIdx of eventStartIndices) {
                    let startIdx = eventIdx;
                    for (let i = eventIdx; i >= 0; i--) { if (Math.abs(data[i].price - cumMax[i]) < 0.000001) { startIdx = i; break; } }
                    let minIdx = eventIdx, minPrice = data[eventIdx].price, recoveryIdx = null;
                    const targetPrice = cumMax[startIdx];
                    for(let i = eventIdx; i < data.length; i++) {
                        if(data[i].price < minPrice) { minPrice = data[i].price; minIdx = i; }
                        if(data[i].price >= targetPrice) { recoveryIdx = i; break; }
                    }
                    daysToBottom.push(minIdx - startIdx);
                    if(recoveryIdx !== null) { daysUnderwater.push(recoveryIdx - startIdx); }
                }
                const avgDaysToBottom = daysToBottom.length > 0 ? getMean(daysToBottom) : NaN;
                const avgDaysUnderwater = daysUnderwater.length > 0 ? getMean(daysUnderwater) : NaN;
                const totalEvents = daysToBottom.length;
                const recoveriesCount = daysUnderwater.length;
                const recoveryRate = totalEvents > 0 ? recoveriesCount / totalEvents : NaN;
                let pctReachedBottom = NaN;
                if(!isNaN(avgDaysToBottom) && totalEvents > 0) { pctReachedBottom = daysToBottom.filter(d => d <= avgDaysToBottom).length / totalEvents; }
                let pctRecovered = NaN;
                if(!isNaN(avgDaysUnderwater) && recoveriesCount > 0) { pctRecovered = daysUnderwater.filter(d => d <= avgDaysUnderwater).length / recoveriesCount; }

                durationResults.push({ label: threshLabel, totalEvents, avgDaysToBottom, pctReachedBottom, avgDaysUnderwater, pctRecovered, recoveryRate });
            }
            return durationResults;
        }
        function renderDrawdownDurationTable(results) {
            const tbody = document.getElementById('ddDurationTableBody');
            tbody.innerHTML = results.map(r => `
                <tr class="border-b hover:bg-purple-50 transition-colors">
                    <td class="px-4 py-3 font-bold text-gray-900">${r.label}</td>
                    <td class="px-4 py-3 text-center text-gray-500">${r.totalEvents}</td>
                    <td class="px-4 py-3 text-right font-mono text-blue-600">${isNaN(r.avgDaysToBottom) ? '-' : Math.round(r.avgDaysToBottom)}</td>
                    <td class="px-4 py-3 text-right text-xs text-gray-500">${isNaN(r.pctReachedBottom) ? '-' : fmtPct(r.pctReachedBottom)}</td>
                    <td class="px-4 py-3 text-right font-mono text-purple-600">${isNaN(r.avgDaysUnderwater) ? '-' : Math.round(r.avgDaysUnderwater)}</td>
                    <td class="px-4 py-3 text-right text-xs text-gray-500">${isNaN(r.pctRecovered) ? '-' : fmtPct(r.pctRecovered)}</td>
                    <td class="px-4 py-3 text-right font-bold text-green-600">${isNaN(r.recoveryRate) ? '-' : fmtPct(r.recoveryRate)}</td>
                </tr>`).join('');
        }

        // --- 2) SEASONALITY YOY ---
        function calculateYoYAnalysis(data) {
            if(data.length === 0) return null;
            const lastDate = data[data.length-1].date;
            const currentYear = lastDate.getFullYear();
            const currentDOY = getDayOfYear(lastDate);
            const yearsMap = new Map();
            data.forEach(d => {
                const y = d.date.getFullYear();
                if(!yearsMap.has(y)) yearsMap.set(y, []);
                yearsMap.get(y).push(d);
            });
            const traces = [], statsList = [], allYears = Array.from(yearsMap.keys()).sort();
            allYears.forEach(year => {
                const yearData = yearsMap.get(year);
                if(yearData.length < 2) return;
                const firstPrice = yearData[0].price;
                const doyArray = [], ytdArray = [];
                yearData.forEach(d => { doyArray.push(getDayOfYear(d.date)); ytdArray.push((d.price / firstPrice) - 1); });
                if(year === currentYear) {
                    traces.push({ x: doyArray, y: ytdArray, mode: 'lines', line: { color: 'red', width: 3 }, name: `${year} (Actual)` });
                    traces.push({ x: [doyArray[doyArray.length-1]], y: [ytdArray[ytdArray.length-1]], mode: 'markers+text', marker: {color:'red', size: 8}, text: [fmtPct(ytdArray[ytdArray.length-1])], textposition: 'top left', showlegend:false });
                } else {
                    const solidX = [], solidY = [], dashX = [], dashY = [];
                    for(let i=0; i<doyArray.length; i++) {
                        if(doyArray[i] <= currentDOY) { solidX.push(doyArray[i]); solidY.push(ytdArray[i]); } 
                        if(doyArray[i] >= currentDOY || (i>0 && doyArray[i] > currentDOY && doyArray[i-1] < currentDOY)) {
                             dashX.push(doyArray[i]); dashY.push(ytdArray[i]);
                             if(dashX.length === 1 && i>0) { dashX.unshift(doyArray[i-1]); dashY.unshift(ytdArray[i-1]); }
                        }
                    }
                    traces.push({ x: solidX, y: solidY, mode: 'lines', line: { color: 'gray', width: 1, opacity: 0.4 }, showlegend: false, hoverinfo: 'none' });
                    traces.push({ x: dashX, y: dashY, mode: 'lines', line: { color: 'gray', width: 1, opacity: 0.4, dash: 'dash' }, showlegend: false, hoverinfo: 'none' });
                }
                let closeIdx = 0, minDiff = 999;
                for(let i=0; i<doyArray.length; i++) { const diff = Math.abs(doyArray[i] - currentDOY); if(diff < minDiff) { minDiff = diff; closeIdx = i; } }
                const cutoffPrice = yearData[closeIdx].price;
                const ytdPerf = (cutoffPrice / firstPrice) - 1;
                let restPerf = null, totalPerf = null;
                if(year < currentYear) { const endPrice = yearData[yearData.length-1].price; restPerf = (endPrice / cutoffPrice) - 1; totalPerf = (endPrice / firstPrice) - 1; }
                statsList.push({ year, ytdPerf, restPerf, totalPerf, isCurrent: year === currentYear });
            });
            traces.push({x:[null],y:[null], mode:'lines', line:{color:'gray', width:1, dash:'dash'}, name:'Años Previos'});
            return { traces, statsList, currentYear, lastDate };
        }
        function renderSeasonalityYoY(data, ticker) {
            if(!data) return;
            const { traces, statsList } = data;
            const layout = {
                title: `Evolución YTD: ${ticker}`,
                xaxis: { title: 'Mes del Año', tickvals: [1, 32, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335], ticktext: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'] },
                yaxis: { title: 'Retorno Acumulado (%)', tickformat: '.0%' },
                margin: {t:40, l:50, r:20, b:40}, showlegend: true, legend: {x: 0, y: 1}
            };
            Plotly.newPlot('seasonalityYoYChart', traces, layout, {responsive: true});
            const sorted = [...statsList].sort((a,b) => b.ytdPerf - a.ytdPerf);
            document.getElementById('rankingYoYTableBody').innerHTML = sorted.map((r, i) => {
                const rank = i + 1;
                const bgClass = r.isCurrent ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'hover:bg-gray-50';
                const fontClass = r.isCurrent ? 'font-bold text-gray-900' : 'text-gray-600';
                return `<tr class="${bgClass} border-b transition-colors"><td class="px-4 py-2 ${fontClass}">#${rank}</td><td class="px-4 py-2 ${fontClass}">${r.year}</td><td class="px-4 py-2 text-right font-mono ${r.ytdPerf > 0 ? 'text-green-600' : 'text-red-600'} ${fontClass}">${fmtPct(r.ytdPerf)}</td><td class="px-4 py-2 text-right text-gray-500 text-xs">${r.restPerf !== null ? fmtPct(r.restPerf) : '-'}</td><td class="px-4 py-2 text-right font-bold text-xs">${r.totalPerf !== null ? fmtPct(r.totalPerf) : '-'}</td></tr>`;
            }).join('');
            const pastYears = statsList.filter(x => !x.isCurrent && x.restPerf !== null);
            const currentStat = statsList.find(x => x.isCurrent);
            if(pastYears.length > 0 && currentStat) {
                const rests = pastYears.map(x => x.restPerf).sort((a,b)=>a-b);
                const medianRest = rests[Math.floor(rests.length/2)];
                const posCount = rests.filter(r => r > 0).length;
                const projectedTotal = ((1 + currentStat.ytdPerf) * (1 + medianRest)) - 1;
                const currPrice = currentData[currentData.length-1].price;
                const projPrice = currPrice * (1 + medianRest);
                document.getElementById('projectionStatsBox').innerHTML = `
                    <div class="flex justify-between border-b border-blue-200 pb-1"><span>Mediana Histórica (Resto Año):</span><span class="font-bold ${medianRest>0?'text-green-600':'text-red-600'}">${fmtPct(medianRest)}</span></div>
                    <div class="flex justify-between border-b border-blue-200 pb-1"><span>Probabilidad Cierre Positivo:</span><span class="font-bold">${fmtPct(posCount / rests.length)}</span></div>
                    <div class="flex justify-between border-b border-blue-200 pb-1"><span>Rentabilidad Total Estimada:</span><span class="font-bold text-blue-700">${fmtPct(projectedTotal)}</span></div>
                    <div class="flex justify-between pt-1"><span>Precio Objetivo Est.:</span><span class="font-mono font-bold">${projPrice.toFixed(2)}</span></div>`;
            }
        }
        function getDayOfYear(date) { const start = new Date(date.getFullYear(), 0, 0); return Math.floor((date - start) / (1000 * 60 * 60 * 24)); }

        // --- CORRELATION ---
        async function runCorrelationAnalysis() {
            const input = document.getElementById('corrTickersInput').value;
            const tickers = input.split(',').map(t => t.trim().toUpperCase()).filter(t => t.length > 0);
            const frequency = document.getElementById('corrFrequency').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if(tickers.length < 2) return alert("Por favor introduce al menos 2 activos.");
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('corrResults').classList.add('hidden');
            updateStatus(`Descargando ${tickers.length} activos para correlaciones...`);
            try {
                const promises = tickers.map(t => fetchYahooData(t, startDate, endDate).catch(e => { console.error(e); return null; }));
                const results = await Promise.all(promises);
                const validData = [], validTickers = [];
                results.forEach((r, i) => { if(r && r.length > 0) { validData.push(r); validTickers.push(tickers[i]); } });
                if(validData.length < 2) throw new Error("No hay suficientes datos válidos.");
                const dateMap = new Map();
                validData[0].forEach(d => { dateMap.set(d.date.toISOString().split('T')[0], { [validTickers[0]]: d.price, dateObj: d.date }); });
                for(let i=1; i<validData.length; i++) {
                    const currentTicker = validTickers[i];
                    validData[i].forEach(d => { const dStr = d.date.toISOString().split('T')[0]; if(dateMap.has(dStr)) { dateMap.get(dStr)[currentTicker] = d.price; } });
                }
                const alignedRows = [];
                for(const [dateStr, pricesObj] of dateMap.entries()) { if(Object.keys(pricesObj).length === validTickers.length + 1) { alignedRows.push(pricesObj); } }
                alignedRows.sort((a,b) => a.dateObj - b.dateObj);
                let resampled = alignedRows;
                if(frequency !== 'D') { resampled = resampleData(alignedRows, frequency); }
                const returnsObj = {}, dates = [];
                validTickers.forEach(t => returnsObj[t] = []);
                for(let i=1; i<resampled.length; i++) {
                    let hasData = true; const rowRets = {};
                    validTickers.forEach(t => { const p0 = resampled[i-1][t], p1 = resampled[i][t]; if(p0 && p1) rowRets[t] = (p1/p0) - 1; else hasData = false; });
                    if(hasData) { dates.push(resampled[i].dateObj); validTickers.forEach(t => returnsObj[t].push(rowRets[t])); }
                }
                globalCorrData = { returnsObj, dates, validTickers, frequency };
                const matrix = calculateCorrelationMatrix(returnsObj, validTickers);
                renderCorrelationMatrix(matrix, validTickers);
                setupRollingUI(validTickers);
                updateRollingChart();
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('corrResults').classList.remove('hidden');
                updateStatus("Correlaciones calculadas.");
            } catch(e) { console.error(e); document.getElementById('loader').classList.add('hidden'); alert("Error: " + e.message); }
        }
        function resampleData(rows, freq) {
            const getGroup = (d) => { if(freq === 'M') return `${d.getFullYear()}-${d.getMonth()}`; if(freq === 'A') return `${d.getFullYear()}`; if(freq === '6M') return `${d.getFullYear()}-${Math.floor(d.getMonth()/6)}`; return null; };
            const groupMap = new Map();
            rows.forEach(row => { groupMap.set(getGroup(row.dateObj), row); });
            return Array.from(groupMap.values()).sort((a,b) => a.dateObj - b.dateObj);
        }
        function calculateCorrelationMatrix(returnsObj, tickers) {
            const n = tickers.length; const matrix = Array(n).fill().map(() => Array(n).fill(0));
            for(let i=0; i<n; i++) { for(let j=0; j<n; j++) { if(i === j) { matrix[i][j] = 1; } else if (i < j) { const corr = getCorrelation(returnsObj[tickers[i]], returnsObj[tickers[j]]); matrix[i][j] = corr; matrix[j][i] = corr; } } }
            return matrix;
        }
        function getCorrelation(x, y) {
            const n = x.length; if(n !== y.length || n === 0) return 0;
            const sumX = x.reduce((a,b)=>a+b,0), sumY = y.reduce((a,b)=>a+b,0), sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0), sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0), sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            return denominator === 0 ? 0 : ((n * sumXY) - (sumX * sumY)) / denominator;
        }
        function renderCorrelationMatrix(z, tickers) {
            // CUSTOM SCALE REQUESTED: -1 (Blue) to 1 (White)
            const data = [{ z: z, x: tickers, y: tickers, type: 'heatmap', 
                colorscale: [[0, '#1e3a8a'], [1, 'white']], 
                zmin: -1, zmax: 1, text: z.map(row => row.map(val => val.toFixed(2))), hoverinfo: 'x+y+z', texttemplate: "%{text}" 
            }];
            Plotly.newPlot('corrMatrixChart', data, { title: 'Matriz de Correlación (Azul -1 a Blanco +1)', margin: {t:50, l:100, b:100}, height: 600 }, {responsive: true});
        }
        function setupRollingUI(tickers) {
            const selA = document.getElementById('rollAssetA'), selB = document.getElementById('rollAssetB');
            selA.innerHTML = ''; selB.innerHTML = '';
            tickers.forEach((t, i) => { const optA = new Option(t, t), optB = new Option(t, t); if(i===0) optA.selected = true; if(i===1) optB.selected = true; selA.add(optA); selB.add(optB); });
        }
        function updateRollingChart() {
            if(!globalCorrData) return;
            const tickerA = document.getElementById('rollAssetA').value, tickerB = document.getElementById('rollAssetB').value, windowSize = parseInt(document.getElementById('rollWindow').value);
            if(tickerA === tickerB) return alert("Selecciona activos diferentes.");
            const retsA = globalCorrData.returnsObj[tickerA], retsB = globalCorrData.returnsObj[tickerB], dates = globalCorrData.dates;
            const rollingCorr = [], rollingDates = [];
            for(let i = windowSize; i < retsA.length; i++) {
                const sliceA = retsA.slice(i - windowSize, i), sliceB = retsB.slice(i - windowSize, i);
                rollingCorr.push(getCorrelation(sliceA, sliceB)); rollingDates.push(dates[i]);
            }
            Plotly.newPlot('rollingCorrChart', [{ x: rollingDates.map(d => d.toISOString().split('T')[0]), y: rollingCorr, mode: 'lines', line: { color: '#4f46e5', width: 2 }, name: 'Rolling Corr' }], { title: `Rolling Correlation (${windowSize})`, yaxis: { range: [-1.1, 1.1], title: 'Correlación' }, shapes: [{ type: 'line', x0: rollingDates[0], x1: rollingDates[rollingDates.length-1], y0: 0, y1: 0, line: {color: 'black', dash: 'dot', width: 1} }], margin: {t:40, l:50, r:20, b:40} }, {responsive: true});
            Plotly.newPlot('rollingHistChart', [{ x: rollingCorr, type: 'histogram', marker: { color: '#818cf8' }, nbinsx: 20 }], { title: 'Distribución', xaxis: { title: 'Correlación', range: [-1, 1] }, margin: {t:40, l:40, r:20, b:40} }, {responsive: true});
        }

        // --- VIX ANALYSIS ---
        function calculateVixAnalysis(assetData, vixData, threshold = 20) {
            if(!vixData || vixData.length === 0) return null;
            const vixMap = new Map(); vixData.forEach(d => vixMap.set(d.date.toISOString().split('T')[0], d.price));
            const merged = []; assetData.forEach(d => { const dStr = d.date.toISOString().split('T')[0]; if(vixMap.has(dStr)) { merged.push({ date: d.date, assetPrice: d.price, vixPrice: vixMap.get(dStr) }); } });
            
            const events = []; let lastEventDate = null;
            const getDaysDiff = (d1, d2) => (d1 - d2) / (1000 * 60 * 60 * 24);
            for(let i=0; i<merged.length; i++) { if(merged[i].vixPrice > threshold) { if(lastEventDate === null || getDaysDiff(merged[i].date, lastEventDate) > 1) { events.push(i); lastEventDate = merged[i].date; } } }
            
            // Added '36 meses'
            const horizons = { '1 mes': 21, '6 meses': 126, '12 meses': 252, '36 meses': 756, '60 meses': 1260 };
            const results = [], histogramData = [];
            for(const [label, days] of Object.entries(horizons)) {
                const returns = [];
                events.forEach(idx => { if(idx + days < merged.length && idx + 1 < merged.length) { returns.push((merged[idx+days].assetPrice/merged[idx+1].assetPrice)-1); } });
                if(label === '12 meses') histogramData.push(...returns);
                if(returns.length > 0) { const pos = returns.filter(r => r > 0).length; results.push({ horizon: label, events: returns.length, mean: getMean(returns), median: getPercentile(returns, 50), min: Math.min(...returns), max: Math.max(...returns), positives: pos, winRate: pos/returns.length }); } else { results.push({ horizon: label, events: 0, mean: 0, median: 0, min: 0, max: 0, positives: 0, winRate: 0 }); }
            }
            const scatterPoints = []; const horizon12m = 252;
            for(let i=0; i<merged.length - horizon12m; i++) { scatterPoints.push({ vix: merged[i].vixPrice, ret: (merged[i+horizon12m].assetPrice / merged[i+1].assetPrice) - 1 }); }
            const peaks = [];
            for(let i=1; i<merged.length-1; i++) { if(merged[i].vixPrice > merged[i-1].vixPrice && merged[i].vixPrice > merged[i+1].vixPrice) { const getRet = (days) => (i + days < merged.length) ? (merged[i+days].assetPrice / merged[i+1].assetPrice) - 1 : null; peaks.push({ date: merged[i].date, vix: merged[i].vixPrice, ret1y: getRet(252), ret3y: getRet(756), ret5y: getRet(1260) }); } }
            return { stats: results, hist12M: histogramData, scatter: scatterPoints, topPeaks: peaks.sort((a,b) => b.vix - a.vix).slice(0, 10) };
        }
        function renderVixAnalysis(data, vixRaw, threshold) {
            if(!data) return;
            const { stats, hist12M, scatter, topPeaks } = data;
            const xVix = vixRaw.map(d => d.date), yVix = vixRaw.map(d => d.price), currentVix = yVix[yVix.length - 1];
            
            // Plot VIX Price
            Plotly.newPlot('vixPriceChart', [
                { x: xVix, y: yVix, type: 'scatter', mode: 'lines', line: { color: '#00008b', width: 1.5 }, name: `VIX: ${currentVix.toFixed(2)}` },
                { x: [xVix[0], xVix[xVix.length-1]], y: [threshold, threshold], mode: 'lines', line: { color: 'purple', dash: 'dash' }, name: `Nivel ${threshold}` }
            ], { title: `Evolución VIX (Actual: ${currentVix.toFixed(2)})`, yaxis: {title: 'VIX'}, margin: {t:40, l:50, r:20, b:40} }, {responsive: true});

            const tbody = document.getElementById('vixStatsTableBody');
            const order = ['1 mes', '6 meses', '12 meses', '36 meses', '60 meses'];
            const sortedStats = stats.sort((a,b) => order.indexOf(a.horizon) - order.indexOf(b.horizon));
            tbody.innerHTML = sortedStats.map(r => `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 font-medium">${r.horizon}</td><td class="px-4 py-3 text-center text-gray-500">${r.events}</td><td class="px-4 py-3 text-right font-bold">${fmtPct(r.mean)}</td><td class="px-4 py-3 text-right">${fmtPct(r.median)}</td><td class="px-4 py-3 text-right text-red-500">${fmtPct(r.min)}</td><td class="px-4 py-3 text-right text-green-600">${fmtPct(r.max)}</td><td class="px-4 py-3 text-right">${r.positives}</td><td class="px-4 py-3 text-right font-bold text-purple-600">${fmtPct(r.winRate)}</td></tr>`).join('');

            // VIX Bar Chart with Min/Max Error Bars (Updated to support individual legend items)
            // Colors: Blue gradient
            const colors = ['#bfdbfe', '#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a'];
            const traces = sortedStats.map((s, i) => ({
                x: [s.horizon],
                y: [s.mean],
                type: 'bar',
                name: `${s.horizon} - Prom: ${fmtPct(s.mean)}, Pos: ${fmtPct(s.winRate)}`, // Legend Text
                marker: { color: colors[i % colors.length], line: {color: 'black', width: 1} },
                error_y: { 
                    type: 'data', 
                    symmetric: false,
                    array: [s.max - s.mean], 
                    arrayminus: [s.mean - s.min], 
                    visible: true, 
                    color: '#0f172a',
                    thickness: 1.5,
                    width: 5
                },
                hoverinfo: 'y+name'
            }));

            Plotly.newPlot('vixBarChart', traces, { 
                title: `Retornos tras VIX > ${threshold}`, 
                yaxis: { tickformat: '.1%', title: 'Rentabilidad' }, 
                margin: {t:40, l:50, r:20, b:40},
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h', font: {size: 10} } // Horizontal legend top
            }, {responsive: true});

            // VIX Histogram (Removed Normal Curve)
            const histData = hist12M.map(r => r*100);
            
            Plotly.newPlot('vixHistogram', [
                { x: histData, type: 'histogram', marker: { color: '#00008b', opacity: 0.7 }, name: 'Frecuencia', nbinsx: 25 }
            ], { 
                title: 'Distribución 12 Meses', 
                xaxis: {title: 'Retorno (%)'}, 
                yaxis: {title: 'Frecuencia'},
                margin: {t:40, l:50, r:50, b:40}, showlegend: false
            }, {responsive: true});

            // VIX Scatter with Regression Stats (Modified)
            const xs = scatter.map(p => p.vix), ys = scatter.map(p => p.ret * 100);
            const reg = calculateRegressionStats(xs, ys);
            
            const minX = Math.min(...xs), maxX = Math.max(...xs);
            Plotly.newPlot('vixScatterChart', [
                { x: xs, y: ys, mode: 'markers', type: 'scatter', marker: {color: '#3b82f6', size: 3, opacity: 0.4}, name: 'Datos' },
                { x: [minX, maxX], y: [reg.slope*minX+reg.intercept, reg.slope*maxX+reg.intercept], mode: 'lines', line: {color: 'red', width: 2}, name: `Regresión` }
            ], { 
                title: `VIX vs Retorno 12M | y=${reg.slope.toFixed(2)}x ${reg.intercept>=0?'+':''}${reg.intercept.toFixed(2)} | R²=${reg.r2.toFixed(3)}`, 
                xaxis: {title: 'Valor VIX'}, 
                yaxis: {title: 'Retorno Futuro (%)'}, 
                margin: {t:40, l:50, r:20, b:40}, showlegend: true
            }, {responsive: true});

            const peaksBody = document.getElementById('vixPeaksTableBody');
            peaksBody.innerHTML = topPeaks.map(p => `<tr class="border-b hover:bg-red-50"><td class="px-4 py-2 font-mono text-sm text-gray-600">${fmtDate(p.date)}</td><td class="px-4 py-2 text-right font-bold text-red-600">${p.vix.toFixed(2)}</td><td class="px-4 py-2 text-right ${p.ret1y > 0 ? 'text-green-600' : 'text-red-600'}">${p.ret1y ? fmtPct(p.ret1y) : '-'}</td><td class="px-4 py-2 text-right ${p.ret3y > 0 ? 'text-green-600' : 'text-red-600'}">${p.ret3y ? fmtPct(p.ret3y) : '-'}</td><td class="px-4 py-2 text-right ${p.ret5y > 0 ? 'text-green-600' : 'text-red-600'}">${p.ret5y ? fmtPct(p.ret5y) : '-'}</td></tr>`).join('');
        }

        function calculateOilAnalysis(assetData, oilData) {
            if(!oilData || oilData.length === 0) return null;
            const oilMap = new Map(); oilData.forEach(d => { oilMap.set(d.date.toISOString().split('T')[0], d.price); });
            const merged = []; assetData.forEach(d => { const dStr = d.date.toISOString().split('T')[0]; if (oilMap.has(dStr)) { merged.push({ date: d.date, assetPrice: d.price, oilPrice: oilMap.get(dStr) }); } });
            const threshold = 100, events = []; let lastEventDate = null;
            const getDaysDiff = (d1, d2) => (d1 - d2) / (1000 * 60 * 60 * 24);
            for (let i = 0; i < merged.length; i++) {
                if (merged[i].oilPrice > threshold) {
                    let isNewEvent = false;
                    if (lastEventDate === null) { isNewEvent = true; } else { if (getDaysDiff(merged[i].date, lastEventDate) > 1) { isNewEvent = true; } }
                    if (isNewEvent) { events.push(i); lastEventDate = merged[i].date; }
                }
            }
            // Added '36 meses'
            const horizons = { '1 semana': 5, '1 mes': 21, '6 meses': 126, '12 meses': 252, '36 meses': 756 };
            const results = [], histogramData = [];
            for (const [label, days] of Object.entries(horizons)) {
                const returns = [];
                events.forEach(idx => { if (idx + days < merged.length && idx + 1 < merged.length) { returns.push((merged[idx+days].assetPrice / merged[idx+1].assetPrice) - 1); } });
                if (label === '6 meses') { histogramData.push(...returns); }
                if (returns.length > 0) { const pos = returns.filter(r => r > 0).length; results.push({ horizon: label, events: returns.length, mean: getMean(returns), median: getPercentile(returns, 50), min: Math.min(...returns), max: Math.max(...returns), positives: pos, winRate: pos / returns.length }); } else { results.push({ horizon: label, events: 0, mean: 0, median: 0, min: 0, max: 0, positives: 0, winRate: 0 }); }
            }
            return { stats: results, hist6M: histogramData };
        }
        function renderOilAnalysis(data, oilRaw) {
            if(!data) return;
            const { stats, hist6M } = data;
            const oilX = oilRaw.map(d => d.date), oilY = oilRaw.map(d => d.price);
            Plotly.newPlot('oilPriceChart', [{ x: oilX, y: oilY, type: 'scatter', mode: 'lines', line: { color: 'black', width: 1.5 }, name: 'Petróleo (CL=F)' }, { x: [oilX[0], oilX[oilX.length-1]], y: [100, 100], type: 'scatter', mode: 'lines', line: { color: 'red', dash: 'dash', width: 2 }, name: 'Umbral 100' }], { title: 'Evolución Petróleo (CL=F)', yaxis: { title: 'Precio (USD)' }, margin: {t:40, l:50, r:20, b:40}, showlegend: true }, {responsive: true});
            const tbody = document.getElementById('oilStatsTableBody');
            const order = ['1 semana', '1 mes', '6 meses', '12 meses', '36 meses'];
            const sortedStats = stats.sort((a,b) => order.indexOf(a.horizon) - order.indexOf(b.horizon));
            tbody.innerHTML = sortedStats.map(r => `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 font-medium">${r.horizon}</td><td class="px-4 py-3 text-center text-gray-500">${r.events}</td><td class="px-4 py-3 text-right font-bold">${fmtPct(r.mean)}</td><td class="px-4 py-3 text-right">${fmtPct(r.median)}</td><td class="px-4 py-3 text-right text-red-500">${fmtPct(r.min)}</td><td class="px-4 py-3 text-right text-green-600">${fmtPct(r.max)}</td><td class="px-4 py-3 text-right">${r.positives}</td><td class="px-4 py-3 text-right font-bold text-blue-600">${fmtPct(r.winRate)}</td></tr>`).join('');
            
            // Oil Bar Chart (Updated Style)
            const colors = ['#e5e7eb', '#9ca3af', '#6b7280', '#374151', '#111827']; // Grays
            const traces = sortedStats.map((s, i) => ({
                x: [s.horizon],
                y: [s.mean],
                type: 'bar',
                name: `${s.horizon} - Prom: ${fmtPct(s.mean)}, Pos: ${fmtPct(s.winRate)}`, // Legend Text
                marker: { color: colors[i % colors.length], line: { color: 'black', width: 1 } }, 
                error_y: { 
                    type: 'data', 
                    symmetric: false,
                    array: [s.max - s.mean], 
                    arrayminus: [s.mean - s.min], 
                    visible: true, 
                    color: 'black', 
                    thickness: 1.5, 
                    width: 5 
                },
                hoverinfo: 'y+name'
            }));

            Plotly.newPlot('oilBarChart', traces, { 
                title: 'Rentabilidad Media tras Petróleo > 100', 
                yaxis: { tickformat: '.1%', title: 'Rentabilidad' }, 
                margin: {t:40, l:50, r:20, b:40},
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h', font: {size: 10} }
            }, {responsive: true});
            
            // Oil Histogram (No curve)
            const histData = hist6M.map(r => r*100);

            Plotly.newPlot('oilHistogram', [
                { x: histData, type: 'histogram', marker: { color: '#6b7280', opacity: 0.7 }, nbinsx: 20, name: 'Frecuencia' }
            ], { 
                title: 'Distribución Rentabilidad a 6 Meses', 
                xaxis: { title: 'Rentabilidad (%)' }, 
                yaxis: { title: 'Frecuencia' }, 
                margin: {t:40, l:50, r:50, b:40},
                showlegend: false
            }, {responsive: true});
        }

        function calculateBestDaysAnalysis(data) {
            const returns = []; for (let i = 1; i < data.length; i++) { returns.push({ date: data[i].date, price: data[i].price, ret: (data[i].price / data[i-1].price) - 1, index: i }); }
            const sortedByRet = [...returns].sort((a,b) => b.ret - a.ret);
            const top10 = sortedByRet.slice(0, 10), top20 = sortedByRet.slice(0, 20), top30 = sortedByRet.slice(0, 30);
            const initialCapital = 1000;
            const calcFinal = (skipIndices) => { let capital = initialCapital; const skipSet = new Set(skipIndices); for(let i=0; i<returns.length; i++) { if(!skipSet.has(returns[i].index)) { capital *= (1 + returns[i].ret); } } return capital; };
            return { top10, scenarios: { "Siempre Invertido": calcFinal([]), "Fuera 10 Mejores": calcFinal(top10.map(d => d.index)), "Fuera 20 Mejores": calcFinal(top20.map(d => d.index)), "Fuera 30 Mejores": calcFinal(top30.map(d => d.index)) } };
        }
        function renderBestDaysCharts(d, ticker) {
            Plotly.newPlot('bestDaysBarChart', [{ x: Object.keys(d.scenarios), y: Object.values(d.scenarios), type: 'bar', marker: { color: ['#2563eb', '#64748b', '#94a3b8', '#cbd5e1'] }, text: Object.values(d.scenarios).map(v => fmtNum(v)), textposition: 'auto' }], { yaxis: { title: 'Patrimonio Final' }, margin: {t:30, l:50, r:20, b:40} }, {responsive: true});
            document.getElementById('top10TableBody').innerHTML = d.top10.map((r, i) => `<tr class="border-b hover:bg-blue-50"><td class="px-4 py-2 font-medium text-gray-500">#${i+1}</td><td class="px-4 py-2">${fmtDate(r.date)}</td><td class="px-4 py-2 text-right font-bold text-green-600">${fmtPct(r.ret)}</td></tr>`).join('');
            const dates = currentData.map(d => d.date.toISOString().split('T')[0]), prices = currentData.map(d => d.price);
            // FIX COLOR: Best days background line darker (#64748b instead of #cbd5e1)
            Plotly.newPlot('bestDaysLocationChart', [{ x: dates, y: prices, type: 'scatter', mode: 'lines', name: ticker, line: {color: '#64748b'} }, { x: d.top10.map(r => r.date.toISOString().split('T')[0]), y: d.top10.map(r => r.price), type: 'scatter', mode: 'markers', name: 'Top 10 Días', marker: { color: 'red', size: 8, symbol: 'star' } }], { yaxis: { title: 'Precio' }, xaxis: { title: 'Fecha' }, margin: {t:30, l:50, r:20, b:40}, showlegend: true }, {responsive: true});
        }

        function calculateDipAnalysis(data, drawdowns) {
            // Added '36 meses'
            const thresholds = { '5%': -0.05, '10%': -0.10, '20%': -0.20 }, horizons = { '1 mes': 21, '6 meses': 126, '12 meses': 252, '36 meses': 756, '60 meses': 1260 };
            const results = [], rawEvents = {}; 
            for (const [threshLabel, threshVal] of Object.entries(thresholds)) {
                const eventIndices = []; let lastIdx = -999;
                drawdowns.forEach((dd, i) => { if (dd <= threshVal) { if (i - lastIdx > 1) { eventIndices.push(i); lastIdx = i; } else { lastIdx = i; } } });
                rawEvents[threshLabel] = { indices: eventIndices, forwardRets: {} };
                for (const [horizLabel, days] of Object.entries(horizons)) {
                    const rets = [], scatterData = [];
                    eventIndices.forEach(idx => { if (idx + days < data.length) { const ret = (data[idx + days].price / data[idx + 1].price) - 1; rets.push(ret); scatterData.push({ dd: drawdowns[idx], ret: ret }); } });
                    rawEvents[threshLabel].forwardRets[horizLabel] = rets;
                    if(horizLabel === '12 meses') rawEvents[threshLabel].scatter12M = scatterData;
                    if (rets.length > 0) { results.push({ Umbral: threshLabel, Horizonte: horizLabel, Dias: days, Eventos: rets.length, Media: getMean(rets), Mediana: getPercentile(rets, 50), Min: Math.min(...rets), Max: Math.max(...rets), WinRate: rets.filter(r => r > 0).length / rets.length, P5: getPercentile(rets, 5), P25: getPercentile(rets, 25), P75: getPercentile(rets, 75), P95: getPercentile(rets, 95) }); }
                }
            }
            results.rawEvents = rawEvents; return results;
        }
        function renderDipAnalysisCharts(data, rawEvents, threshold) {
            const tbody = document.getElementById('dipStatsTableBody');
            const order = ['1 mes', '6 meses', '12 meses', '36 meses', '60 meses'];
            const sortedData = data.sort((a, b) => order.indexOf(a.Horizonte) - order.indexOf(b.Horizonte));
            tbody.innerHTML = sortedData.map(row => `<tr class="border-b border-gray-100 hover:bg-green-50 transition-colors"><td class="px-4 py-3 font-medium text-gray-900">${row.Horizonte}</td><td class="px-4 py-3 text-right font-semibold text-blue-600">${fmtPct(row.Media)}</td><td class="px-4 py-3 text-right text-gray-600">${fmtPct(row.Mediana)}</td><td class="px-4 py-3 text-right text-green-600">${fmtPct(row.Max)}</td><td class="px-4 py-3 text-right text-red-500">${fmtPct(row.Min)}</td><td class="px-4 py-3 text-right font-bold">${fmtPct(row.WinRate)}</td><td class="px-4 py-3 text-right text-gray-500">${row.Eventos}</td></tr>`).join('');
            const horizonsX = [1, 6, 12, 36, 60], p5 = [], p25 = [], p50 = [], p75 = [], p95 = [];
            order.forEach(h => { const item = sortedData.find(d => d.Horizonte === h); if(item) { p5.push(item.P5); p25.push(item.P25); p50.push(item.Mediana); p75.push(item.P75); p95.push(item.P95); } else { p5.push(0);p25.push(0);p50.push(0);p75.push(0);p95.push(0); } });
            
            Plotly.newPlot('dipFanChart', [ { x: horizonsX, y: p5, fill: 'none', type: 'scatter', mode: 'lines', line: {width:0, color: '#e0f2fe'}, showlegend:false }, { x: horizonsX, y: p95, fill: 'tonexty', type: 'scatter', mode: 'lines', line: {width:0, color: '#e0f2fe'}, name: '95-5 Range', fillcolor: 'rgba(135, 206, 250, 0.2)' }, { x: horizonsX, y: p25, fill: 'none', type: 'scatter', mode: 'lines', line: {width:0, color: '#7dd3fc'}, showlegend:false }, { x: horizonsX, y: p75, fill: 'tonexty', type: 'scatter', mode: 'lines', line: {width:0, color: '#7dd3fc'}, name: '75-25 Range', fillcolor: 'rgba(70, 130, 180, 0.3)' }, { x: horizonsX, y: p50, type: 'scatter', mode: 'lines+markers', line: {color: 'darkblue', width: 2}, name: 'Mediana' } ], { title: `Fan Chart: Proyección Rentabilidad tras Caída > ${threshold}`, xaxis: { title: 'Meses tras evento', tickvals: [1,6,12,36,60], ticktext: ['1M','6M','12M','36M','60M'] }, yaxis: { tickformat: '.0%', title: 'Rentabilidad Acumulada' }, margin: {t:40, l:50, r:20, b:40} }, {responsive: true});
            
            // Dip Bar Chart (Refactored for Legend and Colors)
            const colors = ['#bfdbfe', '#60a5fa', '#3b82f6', '#1d4ed8', '#1e3a8a']; // Blue Gradient
            const traces = sortedData.map((d, i) => ({
                x: [d.Horizonte],
                y: [d.Media],
                type: 'bar',
                name: `${d.Horizonte} - Prom: ${fmtPct(d.Media)}, Pos: ${fmtPct(d.WinRate)}`, // Legend text
                marker: { color: colors[i % colors.length], line: {color: 'black', width: 1} },
                error_y: { 
                    type: 'data', 
                    symmetric: false,
                    array: [d.Max - d.Media], 
                    arrayminus: [d.Media - d.Min], 
                    visible: true, 
                    color: '#0f172a',
                    thickness: 1.5,
                    width: 5
                },
                hoverinfo: 'y+name'
            }));

            Plotly.newPlot('dipBarChart', traces, { 
                title: `Retorno Medio tras caídas > ${threshold}`, 
                yaxis: { tickformat: '.0%' }, 
                margin: {t:40, l:50, r:20, b:40},
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h', font: {size: 10} } // Top horizontal legend
            }, {responsive: true});
            
            // Dip Histogram (Removed Curve)
            const histData = (rawEvents.forwardRets['12 meses'] || []).map(r => r*100);

            Plotly.newPlot('dipHistChart', [
                { x: histData, type: 'histogram', marker: {color: '#2563eb', opacity: 0.7}, nbinsx: 20, name: 'Frecuencia' }
            ], { 
                title: `Distribución Rentabilidad a 12 Meses`, 
                xaxis: { title: 'Rentabilidad (%)' },
                yaxis: { title: 'Frecuencia' },
                margin: {t:40, l:50, r:50, b:40},
                showlegend: false
            }, {responsive: true});
            
            // Dip Scatter with Regression Stats
            const scatterPoints = rawEvents.scatter12M || [];
            const xs = scatterPoints.map(p => p.dd * 100), ys = scatterPoints.map(p => p.ret * 100);
            const reg = calculateRegressionStats(xs, ys);
            const minX = Math.min(...xs), maxX = Math.max(...xs);
            
            Plotly.newPlot('dipScatterChart', [ 
                { x: xs, y: ys, mode: 'markers', type: 'scatter', marker: { color: 'blue', opacity: 0.6 }, name: 'Datos' }, 
                { x: [minX, maxX], y: [reg.slope*minX+reg.intercept, reg.slope*maxX+reg.intercept], mode: 'lines', line: {color: 'red', width: 2}, name: 'Regresión' } 
            ], { 
                title: `Scatter: Profundidad vs Retorno 12M | R²=${reg.r2.toFixed(3)} | y=${reg.slope.toFixed(2)}x ${reg.intercept>=0?'+':''}${reg.intercept.toFixed(2)}`, 
                xaxis: { title: 'Drawdown (%)' }, 
                yaxis: { title: 'Retorno Futuro 12M (%)' }, 
                margin: {t:40, l:50, r:20, b:40}, showlegend: true 
            }, {responsive: true});
        }

        function calculateGeneralMetrics(data) {
            const prices = data.map(d => d.price), dates = data.map(d => d.date);
            const returns = [], returnsDates = [];
            for (let i = 1; i < prices.length; i++) { returns.push((prices[i] / prices[i-1]) - 1); returnsDates.push(dates[i]); }
            const maReturns = [];
            for (let i = 0; i < returns.length; i++) { if (i < 9) maReturns.push(null); else { let sum = 0; for (let j = 0; j < 10; j++) sum += returns[i-j]; maReturns.push(sum / 10); } }
            const meanRet = getMean(returns), sigma = getStdDev(returns), var95 = getPercentile(returns, 5);
            const initialValue = 1000, finalValue = initialValue * (prices[prices.length-1] / prices[0]);
            const daysElapsed = (dates[dates.length-1] - dates[0]) / 86400000;
            const cagr = Math.pow(prices[prices.length-1] / prices[0], 1/(daysElapsed/365.25)) - 1;
            const bestDay = Math.max(...returns), worstDay = Math.min(...returns);
            let bestPosStreakInfo = {len:0}, bestNegStreakInfo = {len:0}, currPos = 0, currNeg = 0, posStart, negStart;
            for(let i=0; i<returns.length; i++) {
                if(returns[i]>0) { if(currPos===0) posStart=returnsDates[i]; currPos++; currNeg=0; if(currPos>bestPosStreakInfo.len) bestPosStreakInfo={len:currPos,start:posStart,end:returnsDates[i]}; }
                else if(returns[i]<0) { if(currNeg===0) negStart=returnsDates[i]; currNeg++; currPos=0; if(currNeg>bestNegStreakInfo.len) bestNegStreakInfo={len:currNeg,start:negStart,end:returnsDates[i]}; }
                else { currPos=0; currNeg=0; }
            }
            return { returns, returnsDates, maReturns, meanRet, sigma, var95, initialValue, finalValue, totalRet: (prices[prices.length-1]/prices[0])-1, cagr, volAnn: sigma*Math.sqrt(252), bestDay, worstDay, bestDayDate: returnsDates[returns.indexOf(bestDay)], worstDayDate: returnsDates[returns.indexOf(worstDay)], bestPosStreakInfo, bestNegStreakInfo };
        }
        function renderGeneralMetrics(d, ticker) {
            const tbody = document.getElementById('metricsTableBody');
            tbody.innerHTML = [["Valor Inicial", `€${fmtNum(d.initialValue)}`], ["Valor Final", `€${fmtNum(d.finalValue)}`], ["Rentabilidad Total", fmtPct(d.totalRet)], ["CAGR (Anual)", fmtPct(d.cagr)], ["Volatilidad (Anual)", fmtPct(d.volAnn)], ["Mejor Día", `${fmtPct(d.bestDay)} (${fmtDate(d.bestDayDate)})`], ["Peor Día", `${fmtPct(d.worstDay)} (${fmtDate(d.worstDayDate)})`], ["Racha Positiva Max", `${d.bestPosStreakInfo.len} días (${fmtDate(d.bestPosStreakInfo.start)} - ${fmtDate(d.bestPosStreakInfo.end)})`], ["Racha Negativa Max", `${d.bestNegStreakInfo.len} días (${fmtDate(d.bestNegStreakInfo.start)} - ${fmtDate(d.bestNegStreakInfo.end)})`]].map((r, i) => `<tr class="${i%2===0?'bg-white':'bg-gray-50'} hover:bg-blue-50 transition-colors"><td class="px-4 py-3 font-medium">${r[0]}</td><td class="px-4 py-3 text-right text-gray-700">${r[1]}</td></tr>`).join('');
            const dates = d.returnsDates.map(x => x.toISOString().split('T')[0]);
            const m = d.meanRet, s = d.sigma;
            
            const traces = [];
            traces.push({ x: dates, y: d.returns, name: 'Retornos', mode: 'lines', line: {color:'#2563eb', width:1} });
            traces.push({ x: dates, y: d.maReturns, name: 'Media Movil (10)', mode: 'lines', line: {color:'#00008b', width:2} });
            
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m+(3*s), m+(3*s)], mode: 'lines', name: '+3 Sigma', line: {color: '#ef4444', dash: 'dot', width: 1.5} });
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m+(2*s), m+(2*s)], mode: 'lines', name: '+2 Sigma', line: {color: '#f97316', dash: 'dot', width: 1} });
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m+(1*s), m+(1*s)], mode: 'lines', name: '+1 Sigma', line: {color: '#eab308', dash: 'dot', width: 0.5} });
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m-(1*s), m-(1*s)], mode: 'lines', name: '-1 Sigma', line: {color: '#22c55e', dash: 'dot', width: 0.5} });
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m-(2*s), m-(2*s)], mode: 'lines', name: '-2 Sigma', line: {color: '#16a34a', dash: 'dot', width: 1} });
            traces.push({ x: [dates[0], dates[dates.length-1]], y: [m-(3*s), m-(3*s)], mode: 'lines', name: '-3 Sigma', line: {color: '#15803d', dash: 'dot', width: 1.5} });

            Plotly.newPlot('returnsChart', traces, { 
                title: 'Retornos Diarios + Bandas Sigma', xaxis: { title: 'Fecha' }, yaxis: { title: 'Retorno', tickformat: '.1%' }, margin: {t:40, l:60, r:20, b:40}, showlegend: true 
            }, {responsive: true});

            Plotly.newPlot('returnsHistogram', [{ x: d.returns.map(x => x*100), type: 'histogram', nbinsx: 50, marker: {color: '#6366f1'} }], { title: 'Distribución de Rentabilidades', xaxis: { title: 'Retorno (%)' }, yaxis: { title: 'Frecuencia' }, margin: {t:40, l:60, r:20, b:40}, shapes: [{type: 'line', x0: d.meanRet*100, x1: d.meanRet*100, y0: 0, y1: 1, yref: 'paper', line: {color: 'red', dash: 'dot', width: 2}}, {type: 'line', x0: d.var95*100, x1: d.var95*100, y0: 0, y1: 1, yref: 'paper', line: {color: 'red', width: 2}}], annotations: [{x: d.var95*100, y: 0.5, yref: 'paper', text: `VaR 95%: ${fmtPct(d.var95)}`, showarrow: true, ax: 40}] }, {responsive: true});
        }

        // NEW FUNCTION: Render Sigma Events
        function renderSigmaEvents(data) {
            const limit = data.meanRet + (3 * data.sigma);
            const limitNeg = data.meanRet - (3 * data.sigma);
            const events = [];
            for(let i=0; i<data.returns.length; i++) {
                const ret = data.returns[i];
                if(ret > limit || ret < limitNeg) {
                    events.push({ date: data.returnsDates[i], ret: ret, sigma: (ret - data.meanRet) / data.sigma });
                }
            }
            events.sort((a,b) => Math.abs(b.ret) - Math.abs(a.ret)); // Sort by magnitude
            
            document.getElementById('sigmaEventsTableBody').innerHTML = events.map(e => `
                <tr class="border-b hover:bg-red-50">
                    <td class="px-4 py-2">${fmtDate(e.date)}</td>
                    <td class="px-4 py-2 text-right font-bold ${e.ret>0?'text-green-600':'text-red-600'}">${fmtPct(e.ret)}</td>
                    <td class="px-4 py-2 text-right font-mono text-xs text-gray-500">${e.sigma.toFixed(2)} σ</td>
                </tr>
            `).join('');
        }

        function calculateATHAnalysis(data) {
            let maxHigh = -Infinity; const isRecordHigh = new Array(data.length).fill(false), recordIndices = [];
            data.forEach((d, i) => { if (d.price > maxHigh) { maxHigh = d.price; isRecordHigh[i] = true; recordIndices.push(i); } });
            const horizons = { "1M": 21, "3M": 63, "6M": 126, "12M": 252, "24M": 504 }, results = {};
            for (const [label, days] of Object.entries(horizons)) {
                const rec = [], non = [];
                for (let i = 0; i < data.length - days; i++) { const ret = (data[i + days].price / data[i].price) - 1; if (isRecordHigh[i]) rec.push(ret); else non.push(ret); }
                let nonSample = non; if (non.length >= rec.length && rec.length > 0) { const s = [...non]; for (let k = s.length - 1; k > 0; k--) { const j = Math.floor(Math.random() * (k + 1)); [s[k], s[j]] = [s[j], s[k]]; } nonSample = s.slice(0, rec.length); }
                const m1 = getMean(rec), s1 = getStdDev(rec), m2 = getMean(nonSample), s2 = getStdDev(nonSample);
                
                // P-Value approximation
                const tStat = (rec.length>1 && nonSample.length>1) ? (m1 - m2) / Math.sqrt( (s1*s1/rec.length) + (s2*s2/nonSample.length) ) : 0;
                let pText = "> 0.05";
                if(Math.abs(tStat) > 2.58) pText = "< 0.01 (***)";
                else if(Math.abs(tStat) > 1.96) pText = "< 0.05 (*)";

                results[label] = { recordReturns: rec, nonRecordReturnsSample: nonSample, meanRec: m1, stdRec: s1, meanNon: m2, stdNon: s2, n1: rec.length, n2: nonSample.length, tStat: tStat, pValueText: pText };
            }
            return { recordIndices, results };
        }
        function renderATHPriceChart(data, recordIndices, ticker) {
            const dates = data.map(d => d.date.toISOString().split('T')[0]), prices = data.map(d => d.price);
            Plotly.newPlot('athPriceChart', [{ x: dates, y: prices, name: ticker, type: 'scatter', line: {color: '#3b82f6', width: 1.5} }, { x: recordIndices.map(i => dates[i]), y: recordIndices.map(i => prices[i]), name: 'Nuevo Máximo', mode: 'markers', marker: {color: 'red', size: 6} }], { title: `Evolución de Precios y Máximos Históricos`, yaxis: { title: 'Precio' }, margin: {t:40, l:50, r:20, b:40} }, {responsive: true});
        }
        function renderATHWidgets(res) {
            document.getElementById('athStatsTableBody').innerHTML = `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 font-medium">Retorno Medio</td><td class="px-4 py-3 text-right font-bold text-red-600">${fmtPct(res.meanRec)}</td><td class="px-4 py-3 text-right font-bold text-blue-600">${fmtPct(res.meanNon)}</td></tr><tr class="bg-gray-50"><td class="px-4 py-3 font-medium">Muestra (N)</td><td class="px-4 py-3 text-right text-gray-500">${res.n1}</td><td class="px-4 py-3 text-right text-gray-500">${res.n2}</td></tr>`;
            
            const isSig = Math.abs(res.tStat) > 1.96;
            const interpretation = isSig 
                ? "La diferencia ES estadísticamente significativa (p<0.05). Invertir tras ATH es distinto." 
                : "La diferencia NO es estadísticamente significativa. Es probable que sea azar.";
            const colorClass = isSig ? "text-green-700 bg-green-50" : "text-gray-600 bg-gray-50";

            document.getElementById('ttestResult').innerHTML = `
                <div class="mb-2"><span class="font-bold">T-Statistic:</span> ${res.tStat.toFixed(4)}</div>
                <div class="mb-2"><span class="font-bold">Valor P:</span> ${res.pValueText}</div>
                <div class="${colorClass} p-2 rounded border mt-2"><strong>Interpretación:</strong> ${interpretation}</div>
            `;
            Plotly.newPlot('athHistogram', [{ x: res.recordReturns.map(x => x * 100), type: 'histogram', name: 'Tras Máximo', opacity: 0.6, marker: { color: 'red' } }, { x: res.nonRecordReturnsSample.map(x => x * 100), type: 'histogram', name: 'Aleatorio', opacity: 0.6, marker: { color: 'blue' } }], { title: 'Distribución de Retornos (%)', barmode: 'overlay', margin: {t:40, l:50, r:20, b:40} }, {responsive: true});
        }
        
        function calculateAnnualDistribution(data) { const m = {}; data.forEach(d => m[d.date.getFullYear()] = d.price); const y = Object.keys(m).sort(); const r = []; for(let i=1; i<y.length; i++) r.push({ y: y[i], v: (m[y[i]]/m[y[i-1]] - 1)*100 }); return r; }
        function renderAnnualDistributionChart(d, ticker) { 
            if(!d) return; 
            const currentYear = new Date().getFullYear().toString();
            const colors = d.map(item => item.y === currentYear ? '#ef4444' : '#94a3b8');
            const opacities = d.map(item => item.y === currentYear ? 1 : 0.6);
            Plotly.newPlot('annualDistChart', [{ 
                x: d.map(i=>i.y), y: d.map(i=>i.v), type: 'bar', 
                marker: { color: colors, opacity: opacities },
                text: d.map(i=>i.v.toFixed(1)+'%'), textposition: 'auto'
            }], { title: `Distribución anuales (Resaltado: ${currentYear})`, margin: {t:40,l:50,r:20,b:50} }, {responsive: true}); 
        }
        
        // NEW Function: Annual Hist with Years (Tetris Style) - MODIFIED: Gray columns, Black Text
        function renderAnnualHistWithYears(d) {
            if(!d) return;
            const currentYear = new Date().getFullYear().toString();
            
            const binSize = 10;
            const bins = {};
            const vals = d.map(i => i.v);
            const minBin = Math.floor(Math.min(...vals) / binSize) * binSize;
            const maxBin = Math.floor(Math.max(...vals) / binSize) * binSize;

            for(let b = minBin; b <= maxBin; b += binSize) {
                bins[b] = [];
            }

            d.forEach(item => {
                const binKey = Math.floor(item.v / binSize) * binSize;
                if(!bins[binKey]) bins[binKey] = [];
                bins[binKey].push(item);
            });

            const xLabels = [];
            const yCounts = [];
            const textLabels = [];
            const barColors = [];

            const sortedKeys = Object.keys(bins).map(Number).sort((a,b)=>a-b);

            sortedKeys.forEach(k => {
                const yearsInBin = bins[k].sort((a,b) => b.y - a.y); // Newest first
                const label = `${k}% a ${k+binSize}%`;
                xLabels.push(label);
                yCounts.push(yearsInBin.length);
                
                const yearTexts = yearsInBin.map(y => {
                    const yearStr = y.y;
                    // Current year RED, others Black. Columns Gray.
                    return yearStr === currentYear ? `<b style="color:red; font-size:14px;">${yearStr}</b>` : `<span style="font-size:10px; color: black;">${yearStr}</span>`;
                });
                textLabels.push(yearTexts.join('<br>'));
                barColors.push('#d1d5db'); // Gray
            });

            Plotly.newPlot('annualDistHistChart', [{
                x: xLabels,
                y: yCounts,
                type: 'bar',
                marker: { color: barColors, line: {color: 'white', width: 2} },
                text: textLabels,
                textposition: 'inside',
                insidetextanchor: 'middle',
                textfont: { color: 'black' } // All text black unless overridden by HTML
            }], { 
                title: 'Distribución Rentabilidades por Años', 
                yaxis: {title: 'Número de Años'},
                margin: {t:40,l:50,r:20,b:50} 
            }, {responsive: true});
        }

        function calculateSeasonality(data) {
            function rr(fn) { const g={}; data.forEach(d=>g[fn(d.date)]=d.price); const k=Object.keys(g).sort(); const r=[]; for(let i=1;i<k.length;i++) r.push({k:k[i],v:(g[k[i]]/g[k[i-1]])-1}); return r; }
            const wR=rr(d=>{const x=new Date(d); x.setHours(0,0,0,0); x.setDate(x.getDate()+4-(x.getDay()||7)); return `${x.getFullYear()}-W${Math.ceil((((x-new Date(x.getFullYear(),0,1))/86400000)+1)/7)}`;});
            const wA=new Array(54).fill(0).map(()=>[]); wR.forEach(i=>{const w=parseInt(i.k.split('-W')[1]); if(w) wA[w].push(i.v)});
            const mR=rr(d=>`${d.getFullYear()}-${d.getMonth()}`); const mA=new Array(12).fill(0).map(()=>[]); mR.forEach(i=>mA[parseInt(i.k.split('-')[1])].push(i.v));
            const qR=rr(d=>`${d.getFullYear()}-${Math.floor(d.getMonth()/3)+1}`); const qA=new Array(5).fill(0).map(()=>[]); qR.forEach(i=>qA[parseInt(i.k.split('-')[1])].push(i.v));
            return { weekly: wA.map(a=>a.length?getMean(a):null), monthly: mA.map(a=>a.length?getMean(a):0), quarterly: qA.map(a=>a.length?getMean(a):null) };
        }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
        function renderSeasonalityCharts(d, t) {
            const n=new Date(); const cm=n.getMonth(); const cq=Math.floor(cm/3)+1; const cw = getWeekNumber(n);
            const wColors = Array.from({length:53},(_,i)=> (i+1)===cw ? 'black' : '#3b82f6');
            Plotly.newPlot('weeklyChart', [{x:Array.from({length:53},(_,i)=>i+1),y:d.weekly.slice(1), text: d.weekly.slice(1).map(v=>fmtPct(v)), textposition: 'outside', type:'bar', marker:{color:wColors}}], {margin:{t:20,l:50,r:20,b:40}},{responsive:true});
            Plotly.newPlot('monthlyChart', [{x:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],y:d.monthly, text:d.monthly.map(v=>fmtPct(v)), textposition: 'auto', type:'bar',marker:{color:d.monthly.map((_,i)=>i===cm?'black':'#3b82f6')}}], {margin:{t:20,l:50,r:20,b:40}},{responsive:true});
            Plotly.newPlot('quarterlyChart', [{x:['Q1','Q2','Q3','Q4'],y:d.quarterly.slice(1), text:d.quarterly.slice(1).map(v=>fmtPct(v)), textposition: 'auto', type:'bar',marker:{color:[1,2,3,4].map(i=>i===cq?'black':'#3b82f6')}}], {margin:{t:20,l:50,r:20,b:40}},{responsive:true});
        }

        function calculateTechnicalIndicators(data) { const p=data.map(d=>d.price); const ma=w=>{ const r=[]; for(let i=0;i<p.length;i++) r.push(i<w-1?null:p.slice(i-w+1,i+1).reduce((a,b)=>a+b,0)/w); return r; }; return { ma50: ma(50), ma200: ma(200), rsi: calculateRSI(p,14) }; }
        function calculateRSI(p, w) { const r=[]; let g=[], l=[]; for(let i=1;i<p.length;i++) { const d=p[i]-p[i-1]; g.push(d>0?d:0); l.push(d<0?-d:0); } for(let i=0;i<p.length;i++) { if(i<w) {r.push(null); continue;} const ag=g.slice(i-w,i).reduce((a,b)=>a+b,0)/w; const al=l.slice(i-w,i).reduce((a,b)=>a+b,0)/w; r.push(al===0?100:100-(100/(1+ag/al))); } return r; }
        
        function renderTechnicalChart(d, t, k) {
            const x=d.map(i=>i.date), y=d.map(i=>i.price);
            const lastP = y[y.length-1].toFixed(2);
            const last50 = t.ma50[t.ma50.length-1] ? t.ma50[t.ma50.length-1].toFixed(2) : '-';
            const last200 = t.ma200[t.ma200.length-1] ? t.ma200[t.ma200.length-1].toFixed(2) : '-';
            const lastRSI = t.rsi[t.rsi.length-1] ? t.rsi[t.rsi.length-1].toFixed(2) : '-';

            Plotly.newPlot('technicalChart', [
                {x,y,name:`Precio: ${lastP}`}, 
                // MODIFIED COLORS: MA50 gray, MA200 darkblue
                {x,y:t.ma50,name:`MA50: ${last50}`, line:{color:'gray'}}, 
                {x,y:t.ma200,name:`MA200: ${last200}`, line:{color:'#00008b'}}, 
                {x,y:t.rsi,yaxis:'y2',name:`RSI: ${lastRSI}`, line:{color:'#00008b'}}
            ], {
                yaxis:{domain:[0.35,1]}, yaxis2:{domain:[0,0.25]}, 
                margin:{t:40,l:40,r:20,b:40},
                shapes: [ { type: 'line', x0: x[0], x1: x[x.length-1], y0: 50, y1: 50, yref: 'y2', line: {color:'black', width:1} } ]
            }, {responsive:true});
        }

        function calculateRollingStats(d) { return Object.entries(horizonsRolling).map(([k,v]) => { const r=[]; for(let i=0;i<d.length-v;i++) r.push(d[i+v].price/d[i].price-1); return {horizon:k, meanTot:getMean(r), meanAnn:Math.pow(1+getMean(r),252/v)-1, minTot:Math.min(...r), maxTot:Math.max(...r)}; }); }
        function calculateTimeSeries(d) { const r={}; for(const [k,v] of Object.entries(seriesHorizons)) { const x=[],y=[]; for(let i=v;i<d.length;i++) { x.push(d[i].date); y.push(Math.pow(d[i].price/d[i-v].price, 252/v)-1); } r[k]={x,y}; } return r; }
        function calculateDrawdownData(d) { let max=-Infinity, dd=[], cMax=[], mDD=0, mDate=d[0].date; d.forEach(i=>{if(i.price>max)max=i.price; cMax.push(max); const v=i.price/max-1; dd.push(v); if(v<mDD){mDD=v;mDate=i.date;}}); return {drawdowns:dd, cumulativeMax:cMax, maxDD:mDD, maxDDDate:mDate, dates:d.map(i=>i.date)}; }
        function calculateEpisodes(d, cm) { 
            const e=[]; 
            let i=0; 
            while(i<d.length) { 
                if(Math.abs(d[i].price-cm[i])<1e-5) { 
                    const p=d[i]; 
                    let t=p, rec=null, j=i+1; 
                    while(j<d.length) { 
                        if(d[j].price<t.price) t=d[j]; 
                        if(d[j].price>=p.price) { rec=d[j]; break; } 
                        j++; 
                    } 
                    if(t.price<p.price) {
                         e.push({
                             start:p.date, 
                             end:t.date, 
                             recovery:rec?rec.date:null, 
                             length:(t.date-p.date)/864e5, 
                             underwater: ((rec ? rec.date : d[d.length-1].date) - p.date) / 864e5, 
                             drawdown:t.price/p.price-1
                         }); 
                    }
                    i=j; 
                } else i++; 
            } 
            return e.sort((a,b)=>a.drawdown-b.drawdown).slice(0,10); 
        }
        function calculateYearlyStats(d) { const r=[]; for(let i=0; i<d.length; i+=252) { const sub=d.slice(i,i+252); if(sub.length<2) continue; const ret=sub[sub.length-1].price/sub[0].price-1; const vol=getStdDev(sub.map((v,k)=>k?v.price/sub[k-1].price-1:0).slice(1))*Math.sqrt(252); r.push({range:`${fmtDate(sub[0].date)} - ${fmtDate(sub[sub.length-1].date)}`, return:ret, volatility:vol}); } return r; }

        function getMean(a) { return a.reduce((x,y)=>x+y,0)/a.length; }
        function getStdDev(a) { const m=getMean(a); return Math.sqrt(a.reduce((x,y)=>x+Math.pow(y-m,2),0)/(a.length-1)); }
        function getPercentile(a, p) { const s=[...a].sort((x,y)=>x-y); const i=(p/100)*(s.length-1); return s[Math.floor(i)]; }
        function fmtPct(n) { return (n*100).toFixed(2)+'%'; }
        function fmtNum(n) { return n.toLocaleString('es-ES', {minimumFractionDigits: 0, maximumFractionDigits: 0}); }
        function fmtDate(d) { return d.toISOString().split('T')[0]; }

        function renderTable(s) { document.getElementById('statsTableBody').innerHTML = s.map(i=>`<tr><td class="px-4">${i.horizon}</td><td class="px-4 text-right">${fmtPct(i.meanTot)}</td><td class="px-4 text-right text-blue-600">${fmtPct(i.meanAnn)}</td><td class="px-4 text-right text-red-500">${fmtPct(i.minTot)}</td><td class="px-4 text-right text-green-600">${fmtPct(i.maxTot)}</td></tr>`).join(''); }
        
        function renderBarChart(s) { 
            Plotly.newPlot('barChart', [
                {x:s.map(i=>i.horizon), y:s.map(i=>i.meanTot), type:'bar', name:'Total', text: s.map(i=>fmtPct(i.meanTot)), textposition: 'auto'}, 
                {x:s.map(i=>i.horizon), y:s.map(i=>i.meanAnn), type:'bar', name:'Anual', marker:{color:'gray'}, text: s.map(i=>fmtPct(i.meanAnn)), textposition: 'auto'}
            ], {margin:{t:20,l:40,r:20,b:40}}, {responsive:true}); 
        }
        
        function renderLineChart(s) { 
            const colors = {'1 Año': '#93c5fd', '5 Años': '#1e3a8a', '15 Años': '#9ca3af'};
            Plotly.newPlot('lineChart', Object.entries(s).map(([k,v])=>({x:v.x,y:v.y,name:k, line:{color: colors[k]||'black'}})), {yaxis:{tickformat:'.1%'}, margin:{t:20,l:40,r:20,b:40}}, {responsive:true}); 
        }
        
        function renderDrawdownChart(d, dd, t) { 
            Plotly.newPlot('drawdownChart', [
                {x:dd.dates, y:dd.drawdowns, fill:'tozeroy', name:'DD'}
            ], {
                yaxis:{tickformat:'.1%'}, margin:{t:40,l:50,r:20,b:40},
                shapes: [
                    { type: 'line', x0: dd.dates[0], x1: dd.dates[dd.dates.length-1], y0: dd.maxDD, y1: dd.maxDD, line: {color:'red', dash:'dot'} }
                ],
                annotations: [
                    { x: dd.maxDDDate, y: dd.maxDD, text: `Max DD: ${fmtPct(dd.maxDD)}`, showarrow: true, arrowhead: 1, ax: 0, ay: -40, font: {color: 'red'} }
                ]
            }, {responsive:true}); 
        }
        
        function renderDrawdownTable(e) { document.getElementById('drawdownTableBody').innerHTML = e.map((i,k)=>`<tr><td class="px-4">#${k+1}</td><td class="px-4 text-red-600 font-bold">${fmtPct(i.drawdown)}</td><td class="px-4">${fmtDate(i.start)}</td><td class="px-4">${fmtDate(i.end)}</td><td class="px-4">${i.recovery?fmtDate(i.recovery):'-'}</td><td class="px-4">${Math.round(i.length)}</td><td class="px-4">${Math.round(i.underwater)}</td></tr>`).join(''); }
        function renderYearlyTable(d) { document.getElementById('annualTableBody').innerHTML = d.map(i=>`<tr><td class="px-4">${i.range}</td><td class="px-4 text-right font-bold ${i.return>0?'text-green-600':'text-red-500'}">${fmtPct(i.return)}</td><td class="px-4 text-right">${fmtPct(i.volatility)}</td></tr>`).join(''); }

        window.onload = () => { renderTickerDictionary(); };
    </script>
</body>
</html>